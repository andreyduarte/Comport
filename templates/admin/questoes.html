{% extends "admin/base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>‚ùì Gerenciamento de Quest√µes</h1>
    <div>
        <a href="#" class="btn">‚ûï Nova Quest√£o</a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>üîç Filtros e Busca</h2>
    </div>
    <div class="card-body">
        <form method="GET" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <input type="text" name="search" placeholder="Buscar por texto da pergunta..." 
                   value="{{ current_search or '' }}" 
                   style="flex: 1; min-width: 300px; padding: 0.75rem; border: 1px solid #e1e8ed; border-radius: 5px;">
            
            <select name="tema" style="padding: 0.75rem; border: 1px solid #e1e8ed; border-radius: 5px;">
                <option value="">Todos os temas</option>
                {% for tema in temas %}
                    <option value="{{ tema }}" {% if current_tema == tema %}selected{% endif %}>
                        {{ tema.title() }}
                    </option>
                {% endfor %}
            </select>
            
            <button type="submit" class="btn">üîç Filtrar</button>
            <a href="{{ url_for('admin_questoes') }}" class="btn btn-secondary">üîÑ Limpar</a>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>üìã Lista de Quest√µes ({{ pagination.total }} total)</h2>
    </div>
    <div class="card-body">
        {% if questions %}
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>
                                <a href="{{ url_for('admin_questoes', sort='id', order='desc' if current_sort == 'id' and current_order == 'asc' else 'asc', tema=current_tema, search=current_search) }}" 
                                   style="color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                    ID
                                    {% if current_sort == 'id' %}
                                        <span>{{ '‚Üì' if current_order == 'desc' else '‚Üë' }}</span>
                                    {% endif %}
                                </a>
                            </th>
                            <th>Pergunta</th>
                            <th>
                                <a href="{{ url_for('admin_questoes', sort='tema', order='desc' if current_sort == 'tema' and current_order == 'asc' else 'asc', tema=current_tema, search=current_search) }}" 
                                   style="color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                    Tema
                                    {% if current_sort == 'tema' %}
                                        <span>{{ '‚Üì' if current_order == 'desc' else '‚Üë' }}</span>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('admin_questoes', sort='respostas', order='desc' if current_sort == 'respostas' and current_order == 'asc' else 'asc', tema=current_tema, search=current_search) }}" 
                                   style="color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                    Respostas
                                    {% if current_sort == 'respostas' %}
                                        <span>{{ '‚Üì' if current_order == 'desc' else '‚Üë' }}</span>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('admin_questoes', sort='erro', order='desc' if current_sort == 'erro' and current_order == 'asc' else 'asc', tema=current_tema, search=current_search) }}" 
                                   style="color: inherit; text-decoration: none; display: flex; align-items: center; justify-content: space-between;">
                                    Taxa Erro
                                    {% if current_sort == 'erro' %}
                                        <span>{{ '‚Üì' if current_order == 'desc' else '‚Üë' }}</span>
                                    {% endif %}
                                </a>
                            </th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for question in questions %}
                        {% set stats = error_stats.get(question.id, {'errors': 0, 'total': 0}) %}
                        {% set error_rate = (stats.errors / stats.total * 100) if stats.total > 0 else 0 %}
                        <tr>
                            <td><strong>{{ question.id }}</strong></td>
                            <td style="max-width: 400px;">
                                <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    {{ question.pergunta }}
                                </div>
                                <small style="color: #657786;">
                                    Resposta: {{ question.opcoes[question.resposta_correta] }}
                                </small>
                            </td>
                            <td>
                                <span style="background: #f0f2f5; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                    {{ question.get('tema', 'geral').title() }}
                                </span>
                            </td>
                            <td>{{ stats.total }}</td>
                            <td>
                                {% if error_rate > 50 %}
                                    <span style="color: #dc3545; font-weight: bold;">{{ "%.1f"|format(error_rate) }}%</span>
                                {% elif error_rate > 30 %}
                                    <span style="color: #ffc107; font-weight: bold;">{{ "%.1f"|format(error_rate) }}%</span>
                                {% else %}
                                    <span style="color: #28a745;">{{ "%.1f"|format(error_rate) }}%</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('admin_question_detail', question_id=question.id) }}" 
                                   class="btn btn-secondary" style="padding: 0.5rem;">üëÅÔ∏è</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagina√ß√£o -->
            {% if pagination.pages > 1 %}
            <div style="margin-top: 1.5rem; text-align: center;">
                {% if pagination.has_prev %}
                    <a href="{{ url_for('admin_questoes', page=pagination.prev_num, tema=current_tema, search=current_search, sort=current_sort, order=current_order) }}" 
                       class="btn btn-secondary">‚Üê Anterior</a>
                {% endif %}
                
                <span style="margin: 0 1rem;">
                    P√°gina {{ pagination.page }} de {{ pagination.pages }}
                </span>
                
                {% if pagination.has_next %}
                    <a href="{{ url_for('admin_questoes', page=pagination.next_num, tema=current_tema, search=current_search, sort=current_sort, order=current_order) }}" 
                       class="btn btn-secondary">Pr√≥xima ‚Üí</a>
                {% endif %}
            </div>
            {% endif %}
        {% else %}
            <div style="text-align: center; padding: 2rem; color: #657786;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùì</div>
                <h3>Nenhuma quest√£o encontrada</h3>
                <p>Tente ajustar os filtros ou adicionar novas quest√µes.</p>
            </div>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>üìä Resumo</h2>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 2rem; color: #667eea;">{{ pagination.total }}</div>
                <div style="color: #657786;">Total de Quest√µes</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 2rem; color: #28a745;">{{ temas|length }}</div>
                <div style="color: #657786;">Temas Diferentes</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 2rem; color: #ffc107;">
                    {% set high_error = questions|selectattr('id')|list|length %}
                    {% set high_error_count = 0 %}
                    {% for q in questions %}
                        {% set stats = error_stats.get(q.id, {'errors': 0, 'total': 0}) %}
                        {% if stats.total > 0 and (stats.errors / stats.total * 100) > 50 %}
                            {% set high_error_count = high_error_count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ high_error_count }}
                </div>
                <div style="color: #657786;">Alta Taxa de Erro</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}